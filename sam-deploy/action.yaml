name: SAM Package
description: Build and package using SAM

inputs:
  aws-access-key-id:
    description: AWS Access Key ID
    required: true

  aws-region:
    description: AWS Region
    required: true

  aws-secret-access-key:
    description: AWS Secret Access Key
    required: true

  force:
    description: Deploy even though the cache was hit
    required: false
    default: 'false'

  bucket:
    description: S3 bucket name
    required: true

  stack-name:
    description: Name of the stack folder
    required: true

  template:
    description: Name of the stack folder
    required: true

outputs:
  template:
    description: Template file name
    value: ${{ inputs.stack-root }}-template

runs:
  using: composite
  steps:
    - name: Download build
      uses: actions/download-artifact@v2
      with:
        name: ${{ inputs.template }}

    - name: Deduplicate deploy
      id: cache
      uses: actions/cache@v2
      with:
        path: template.yaml # does not really matter
        key: ${{ inputs.aws-access-key-id }}-${{ inputs.stack-name }}-${{ hashFiles('template.yaml') }}

    - name: Setup SAM
      if: steps.cache.outputs.cache-hit != 'true' || inputs.force == 'true'
      uses: aws-actions/setup-sam@v1
      with:
        version: 1.33.0

    - name: Configure AWS credentials
      if: steps.cache.outputs.cache-hit != 'true' || inputs.force == 'true'
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ inputs.aws-access-key-id }}
        aws-region: ${{ inputs.aws-region }}
        aws-secret-access-key: ${{ inputs.aws-secret-access-key }}

    - name: Deploy
      if: steps.cache.outputs.cache-hit != 'true' || inputs.force == 'true'
      run: >-
        sam deploy
        --capabilities CAPABILITY_IAM
        --no-fail-on-empty-changeset
        --no-confirm-changeset
        --region ${{ inputs.aws-region }}
        --s3-bucket ${{ inputs.bucket }}
        --s3-prefix ${{ inputs.stack-name }}
        --stack-name ${{ inputs.stack-name }}
        --template-file template.yaml
      shell: bash
